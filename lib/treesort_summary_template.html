<html>
<head>
   <style>
      
      .treesort-page {
         font-family: "Helvetica Neue", Helvetica, Aria;
         padding: 1.0rem;
      }

      .treesort-page hr {
         border-color: rgba(127, 127, 127, 0.2);
      }

      .treesort--title {
         margin-bottom: 2.0rem;
      }

      .treesort--section-title {
         border-color: rgba(127, 127, 127, 0.2);
         border-style: solid;
         border-width: 0 0 1px 0;
         width: 100%;
      }

      .treesort--background-info {
         margin-bottom: 2.0rem;
      }

      .treesort--output-file-panel {
         margin-bottom: 2.0rem;
      }

      .treesort--segment-title {
         margin-bottom: 0.25rem;
      }

      /* The table of segment-specific file data. */
      .treesort--segment-table {
         border-collapse: collapse;
         font-family: sans-serif;
         font-size: 0.95rem;
         margin: 0.5rem 0 1.5rem 0;
         text-align: left;
         width: 100%;
      }
      .treesort--segment-table th, .treesort--segment-table td {
         border: 1px solid #ccc;
         padding: 0.75em 1em;
      }
      .treesort--segment-table th {
         background-color: #f5f5f5;
         font-weight: bold;
      }
      .treesort--segment-table th.treesort--file {
         width: 40%;
      }

      .treesort--segment-table tr:nth-child(even) {
      background-color: #f9f9f9;
      }
      .treesort--segment-table tr:hover {
         background-color: #f1f1f1;
      }

   </style>
</head>
<body>
   <div class="treesort-page">
      <h1 class="treesort--title">TreeSort analysis results</h1>

      <h2 class="treesort--section-title">About the results</h2>
      <div class="treesort--background-info">The TreeSort tool infers both recent and ancestral reassortment events along the branches of a phylogenetic 
      tree of a fixed genomic segment. It uses a statistical hypothesis testing framework to identify branches where reassortment with 
      other segments has occurred and reports these events.
      </div>

      <h2 class="treesort--section-title">Summary</h2>
      <div class="treesort--output-file-panel">
         TreeSort provided the following summary of its parameters and analysis:
         <div id="treesort_summary"></div>
      </div>

      <h2 class="treesort--section-title">Annotated tree file</h2>
      <div class="treesort--output-file-panel">
         The primary result of the analysis is an annotated tree file: <span id="treesort_output_file"></span>. Information about reassorted segments
         is displayed in the tree visualization at the associated nodes (strains).
      </div>

      <h2 class="treesort--section-title">Reassortment summary</h2>
      <div class="treesort--output-file-panel">
         The annotated tree file includes reassortment information for every node, but this is only useful for visualization. The TreeSort service 
         parses the annotations in the tree file and generates a downloadable summary of all strains where reassortment is suspected: 
         <span id="treesort_reassortments_file"></span>.
      </div>

      <h2 class="treesort--section-title">Segment-specific files</h2>
      <div id="treesort_segment_files"></div>
   </div>

   <script type="text/javascript">

      // Variables populated by run_treesort.py.
      const reassortmentsFilename = "{{reassortments_filename}}";
      const resultFilename = "{{result_filename}}";
      const resultsJSON = "{{results_json}}";
      const segmentList = "{{segments}}";
      const treesortSummary = "{{treesort_summary}}";
      const workspaceFolder = "{{workspace_folder}}";

      // Split the segment list into an array.
      let segments = segmentList.split(",");

      const segmentFiles = [
         { label: "Alignment", path: "-input.fasta.aln", description: "The alignment file"},
         { label: "Dates", path: "-input.fasta.aln.dates.csv", description: "Dates found in the FASTA deflines"},
         { label: "Rooted tree", path: "-input.fasta.aln.rooted.tre", description: "The rooted tree file"},
         { label: "Tree", path: "-input.fasta.tre", description: "The tree file"},

         { label: "Outliers", path: "-input.fasta.aln.treetime/outliers.tsv", description: "A table of outlier data"},
         { label: "Root to tip regression", path: "-input.fasta.aln.treetime/root_to_tip_regression.pdf", description: "A visualization of root-to-tip regression"},
         { label: "Root to tip data (???)", path: "-input.fasta.aln.treetime/rtt.csv", description: "Tbe root-to-tip data (???)"}
      ]

      // Update placeholder text on the page.
      function populatePage() {

         // Get a reference to the output file element.
         const outputFileEl = document.getElementById("treesort_output_file");
         if (outputFileEl) { 
            // Add a link to the output file (the annotated tree file).
            outputFileEl.innerHTML = `<a href="${workspaceFolder}${resultFilename}" target="_blank">${resultFilename}</a>`;
         }

         // Get a reference to the "reassortments file" element.
         const reassortmentsEl = document.getElementById("treesort_reassortments_file");
         if (reassortmentsEl) { 
            // Add a link to the reassortments summary CSV file.
            reassortmentsEl.innerHTML = `<a href="${workspaceFolder}${reassortmentsFilename}" target="_blank">${reassortmentsFilename}</a>`;
         }

         // Get a reference to the summary element.
         const summaryEl = document.getElementById("treesort_summary");
         if (summaryEl) { 
            // Populate the TreeSort summary HTML.
            summaryEl.innerHTML = treesortSummary;
         }

         // Populate the section with segment-specific results.
         populateResultsBySegment();

         console.log("resultsJSON = ", resultsJSON)

      }


      // Populate the section with segment-specific results.
      function populateResultsBySegment() {

         // Get a reference to the "results by segment" element.
         const resultsBySegmentEl = document.getElementById("treesort_segment_files");
         if (!resultsBySegmentEl) { return; }
            
         // Was segment data provided?
         if (!segments || segments.length < 1) { 
            resultsBySegmentEl.innerHTML = "No segments were analyzed";
            return;
         }
         
         let html = "";

         // Iterate over all segments that were included in the analysis.
         segments.forEach((segment_, index_) => {

            let rowsHTML = "";

            // Trim and validate the segment name.
            segment_ = segment_.trim();
            if (!segment_ || segment_.length < 1) { return; }

            segmentFiles.forEach((file_, index_) => {

               // Alternate row classes
               const rowClass = index_ % 2 ? "treesort--even" : "treesort--odd";

               const fileURL = `${workspaceFolder}${segment_}${file_.path}`;

               // Create a row for this file.
               rowsHTML += `<tr class="${rowClass}">
                  <td><a href="${fileURL}" target="_blank">${segment_}${file_.path}</a></td>
                  <td>${file_.description}</td>
               </tr>`;
            })

            html += `<h3 class="treesort--segment-title">${segment_} files</h3>
               <table class="treesort--segment-table">
                  <thead>
                     <tr>
                        <th class="treesort--file">File</th>
                        <th>Description</th>
                     </tr>
                  </thead>
                  <tbody>${rowsHTML}</tbody>
               </table>`;

            html += `<div style="width: 640px; height: 480px;">
               <embed src="${segment_}-input.fasta.aln.treetime/root_to_tip_regression.pdf" type="application/pdf" width="100%" height="100%" />
            </div>`;
         })

         resultsBySegmentEl.innerHTML = html;
      }

      window.addEventListener('load', function() {
         populatePage();
      })
      
   </script>
</body>
</html>